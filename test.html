<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.6/paper/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Open+Sans">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
	<script src="echarts_english.js"></script>
</head>
<body>
<nav class="navbar navbar-inverse navbar-fixed-top ">
    <div class="container">
        <div class="navbar-header">
          <a href="./" class="navbar-brand">Todoist Productivity Stats</a>
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
          </button>
        </div>
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-2">
			<ul class="nav navbar-nav navbar-right">
				<li><a href="https://github.com/ION28/graph_visualizer" target="_blank">GitHub Project <i class="fa fa-external-link" aria-hidden="true"></i></a></li>
			</ul>
		</div>
    </div>
</nav>
<div class="container" id="wrap">
	<div class="row" style="margin-top:100px">
		<div class="col-lg-6">
			<div id="daily_progress_bar" class="progress">
			</div>
			<div id="daily_task_progress" style="width: 100%; height: 400px;"></div>
		</div>
		<div class="col-lg-6">
			<div id="weekly_progress_bar" class="progress">
			</div>
			<div id="weekly_task_progress" style="width: 100%; height: 400px;"></div>
		</div>
	</div>
</div>
<script>
$(function() {
  $(document).ajaxStop(function() {
    $(this).unbind("ajaxStop"); //prevent running again when other calls finish
    draw_graphs();
  });
  api_call_completed_get_stats();
  api_call_projects();
});

function getCookie(name) {
  var value = "; " + document.cookie;
  var parts = value.split("; " + name + "=");
  if (parts.length == 2) return parts.pop().split(";").shift();
}

var project_colors = ["#95ef63", "#ff8581", "#ffc471", "#f9ec75", "#a8c8e4", "#d2b8a3", "#e2a8e4", "#cccccc", "#fb886e", "#ffcc00", "#74e8d3", "#3bd5fb", "#dc4fad", "#ac193d", "#d24726", "#82ba00", "#03b3b2", "#008299", "#5db2ff", "#0072c6", "#000000", "#777777"];

function api_call_completed_get_stats() {
	$.get(
		"https://todoist.com/api/v7/completed/get_stats",
		{token : getCookie("token")},
		function(data) {
		}
	).done(function ( data ) {
		window.karma_stats = data;
	});
}
function api_call_projects() {
	$.get(
		"https://beta.todoist.com/API/v8/projects",
		{token : getCookie("token")},
		function(data) {
		}
	).done(function ( data ) {
		window.projects_data = data;
	});
}

function draw_graphs() {
	console.log(karma_stats);
	console.log(projects_data);
	var total_daily_tasks_completed = karma_stats["days_items"]["0"]["total_completed"];
	var daily_goal = karma_stats["goals"]["daily_goal"];
	var total_weekly_tasks_completed = karma_stats["week_items"]["0"]["total_completed"];
	var weekly_goal = karma_stats["goals"]["weekly_goal"];
	
	var daily_progress = karma_stats["days_items"]["0"]["items"];
	for(var i = 0; i < daily_progress.length; i++) {
		daily_progress[i]['color'] = project_colors[karma_stats['project_colors'][daily_progress[i]['id']]];
		daily_progress[i]['project_name'] = projects_data.filter(function (projects_data) { return projects_data.id == daily_progress[i]['id'] })[0]['name'];
	}
	
	for(var i = 0; i < daily_progress.length; i++) {
		document.getElementById('daily_progress_bar').innerHTML += '<div class="progress-bar" data-placement="top" data-container="body" data-toggle="tooltip" title="' + daily_progress[i]['project_name'] + '" style="width: ' + ((daily_progress[i]['completed']/total_daily_tasks_completed)*100) + '%; background-color:' + (daily_progress[i]['color']) + '"></div>';
	}
	
	var weekly_progress = karma_stats["week_items"]["0"]["items"];
	for(var i = 0; i < weekly_progress.length; i++) {
		weekly_progress[i]['color'] = project_colors[karma_stats['project_colors'][weekly_progress[i]['id']]];
		weekly_progress[i]['project_name'] = projects_data.filter(function (projects_data) { return projects_data.id == weekly_progress[i]['id'] })[0]['name'];
	}
	
	for(var i = 0; i < weekly_progress.length; i++) {
		document.getElementById('weekly_progress_bar').innerHTML += '<div class="progress-bar" data-placement="top" data-container="body" data-toggle="tooltip" title="' + weekly_progress[i]['project_name'] + '" style="width: ' + ((weekly_progress[i]['completed']/total_weekly_tasks_completed)*100) + '%; background-color:' + (weekly_progress[i]['color']) + '"></div>';
	}
	
	$('[data-toggle="tooltip"]').tooltip();
	
	var daily_task_progress_chart = echarts.init(document.getElementById('daily_task_progress'));
	var weekly_task_progress_chart = echarts.init(document.getElementById('weekly_task_progress'));
	daily_task_progress_chart.setOption({
		title : {
			text: 'Daily Task Progress'
		},
		tooltip : {
			formatter: "{a}"
		},
		toolbox: {
			show : true,
			feature : {
				mark : {show: true},
				dataView : {show: true, readOnly: false},
				restore : {show: true},
				saveAsImage : {show: true}
			}
		},
		series: [
			{
				name: 'Tasks Completed',
				type: 'gauge',
				splitNumber: Math.ceil(daily_goal/5) + 1,
				min: 0,
				max: Math.ceil(daily_goal/5)*5 + 5,
				axisLine: {
					lineStyle: {
						color: [[1 - (daily_goal/(Math.ceil(daily_goal/5)*5 + 5)), 'red'],[daily_goal/(Math.ceil(daily_goal/5)*5 + 5), '#1e90ff'],[1, 'green']],
						width: 20,
						shadowColor : '#fff',
						shadowBlur: 10
					}
				},
				detail: {formatter:'{value} Tasks'},
				data: [{value: total_daily_tasks_completed, name: 'Tasks Completed'}]
			}
		]
	 });
	 weekly_task_progress_chart.setOption({
		title : {
			text: 'Weekly Task Progress'
		},
		tooltip : {
			formatter: "{a}"
		},
		toolbox: {
			show : true,
			feature : {
				mark : {show: true},
				dataView : {show: true, readOnly: false},
				restore : {show: true},
				saveAsImage : {show: true}
			}
		},
		series: [
			{
				name: 'Tasks Completed',
				type: 'gauge',
				splitNumber: Math.ceil(weekly_goal/10) + 3,
				min: 0,
				max: Math.ceil(weekly_goal/10)*10 + 30,
				axisLine: {
					lineStyle: {
						color: [[1 - (weekly_goal/(Math.ceil(weekly_goal/10)*10 + 30)), 'red'],[weekly_goal/(Math.ceil(weekly_goal/10)*10 + 30), '#1e90ff'],[1, 'green']],
						width: 20,
						shadowColor : '#fff',
						shadowBlur: 10
					}
				},
				detail: {formatter:'{value} Tasks'},
				data: [{value: total_weekly_tasks_completed, name: 'Tasks Completed'}]
			}
		]
	 });
}
</script>
<script async src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
</body>
</html>
